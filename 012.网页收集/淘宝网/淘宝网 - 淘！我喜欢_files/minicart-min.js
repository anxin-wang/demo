/*! mini-cart 2014-07-18 11:21:16 */
!function(a){var b=TB.Global,c="#J_MiniCart",d="hover",e="menu-bd",f="mini-cart-";"2.0"===b.version&&(c="#J_GHeadCart",d="g_head-menu-hover",e="g_head-menu-bd",f="mini-cart-");var g=KISSY,h=window,i=document,j=!"0"[0],k=j&&!window.XMLHttpRequest,l=i.domain,m=!(l.indexOf("taobao.com")>-1||l.indexOf("tmall.com")>-1),n=m?".daily.taobao.net":".taobao.com",o="http://cart"+n+"/",p=o+"trail_mini_cart.htm?",q=o+"del_mini_cart.htm?",r="\u6b63\u5728\u5220\u9664\u4e2d",s="\u5220\u9664",t=f,u=t+"bd",v=t+"img",w=t+"count",x=t+"del",y=t+"title",z=t+"info",A=t+"ft",B=t+"price h",C=t+"ready",D="data-cartId",E=".",F="",G=function(a){var b=a.match(/&#[0-9]{1,5};/g);if(null!=b){var c,d,e;for(e=0;e<b.length;e++)c=b[e],d=c.substring(2,c.length-1),a=d>=-32768&&65535>=d?a.replace(c,String.fromCharCode(d)):a.replace(c,"")}return a.replace("<","&lt;").replace(">","&gt;")},H=function(a){if(a.css({"white-space":"nowrap",overflow:"hidden"}),"textOverflow"in i.documentElement.style||"OTextOverflow"in i.documentElement.style)a.css({"text-overflow":"ellipsis","-o-text-overflow":"ellipsis"});else{a.data("text")||a.data("text",a.text());var b=a.attr("text")||a.text(),c=a.width(),d=0,e=b.length,f=e,h=new g.Node(a[0].cloneNode(!0)).insertAfter(a);if(a.text(b),h.text(b).css({position:"absolute",width:"auto",visibility:"hidden",overflow:"hidden"}),h.width()>c){for(;(f=Math.floor((e+d)/2))>d;)h.text(b.substr(0,f)+"\u2026"),h.width()>c?e=f:d=f;a.text(b.substr(0,f)+"\u2026"),a.attr("title")||a.attr("title",b)}h.remove()}},I=function(){},J="\u60a8\u8d2d\u7269\u8f66\u91cc\u8fd8\u6ca1\u6709\u4efb\u4f55\u5b9d\u8d1d\u3002",K="\u7cfb\u7edf\u76ee\u524d\u7e41\u5fd9\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002",L="\u60a8\u8d2d\u7269\u8f66\u91cc\u7684\u5b9d\u8d1d\u5747\u5df2\u5931\u6548\u3002";h.MiniCart={init:function(a,b,c){var d=this;a=parseInt(a),isNaN(a)||0>a||(d.cartNum=a,b&&(c&&c(b),g.use("node",function(){d._rendUI(),d.render()})))},reset:function(){this._data=null,this._isRequesting=!1,this.isExpired=!0,this._rendUI()},_rendUI:function(){var a=this;a.trigger=g.one("#J_MiniCart"),a.elem=g.one("#mc-menu-hd"),a.content=a.trigger.one(".menu-bd-panel"),a._bindUI()},_bindUI:function(){var a=this,b=a.content;b.on("click",function(a){if(!TB.Global._OFF){var b,c=new g.Node(a.target);if("a"===c[0].tagName.toLowerCase()&&(b=c.parent(),b.hasClass(x))){if(a.preventDefault(),a.halt(),c.html()===r)return;I("delete"),c.html(r),g.getScript(q+"callback=MiniCart.remove&del_id="+b.parent().attr(D)+"&t="+g.now(),function(){c.html(s),this.parentNode.removeChild(this)})}}})},remove:function(a){var b=this;if(a)if(a.status){var c=b.content,d=c.one(E+u);g.each(d.children(),function(c){if(c=new g.Node(c),c.attr(D)==a.delCart){var d=function(){c.remove?c.remove():c[0].parentNode.removeChild(c[0]),b.setData(a),0===b.cartNum&&b.hide()};return k?d():c.animate?c.animate("opacity: 0",1,"easeOut",d):d(),!1}})}else alert(a.errMsg)},render:function(){var a=this,b=a.content,c=function(b){a.setData({status:!1,errMsg:b})};if(a._isRequesting=!1,(!a._data||a.isExpired)&&!a._isRequesting&&b){if(b.html(F).removeClass(C),a.cartNum<1)return c(J),b.addClass(C),void 0;a._isRequesting=!0,g.later(function(){!a._clicked&&a._isShowing()&&(g.getScript(p+"callback=MiniCart.setData&t="+g.now(),function(){b.addClass(C),this.parentNode.removeChild(this)}),a._setTimeout(function(){c(K)}))},300)}},show:function(){this.render(),this.trigger.addClass("menu-hover")},hide:function(){var a=this;g.later(function(){a.trigger.removeClass(d)},2e3)},_isShowing:function(){return"block"===this.content.css("display")},_parseItem:function(a){var b=this,c=F,d=a.item,e=d?d.length:0,f=0;return e>0&&(f=a.num-e,period=parseInt(a.period,10),c+='<div class="mini-cart-hd"><strong>\u6700\u8fd1\u52a0\u5165\u7684\u5b9d\u8d1d\uff1a</strong></div><ul class="mini-cart-bd">',g.each(d,function(a){var b="http://item"+n+"/item.htm?id="+a.itemId,d=G(a.title);c+="<li "+D+'="'+a.cartId+'"><div class="'+v+'"><a target="_top" href="'+b+'"><img src="'+a.picUrl+'" alt="'+d+'" /></a></div><div class="'+w+'">&yen;<strong class="'+B+'">'+a.price+'</strong></div><div class="'+y+'"><a target="_top" href="'+b+'" title="'+d+'">'+d+'</a></div><div class="'+x+'"><a href="#">\u5220\u9664</a></div>'+(a.sku&&a.sku.length?'<div class="'+z+'"><span>'+a.sku.join("</span><span>")+"</span></div>":F)+(a.prefence?'<span class="flag-1111"></span>':"")+"</li>"}),c+="</ul>"),f>0&&(c+='<div class="'+A+'"><p><strong>'+b._parseRest(f,a.num)+"</strong></p></div>"),c},_parseRest:function(a){return a>0&&45>a?"\u8d2d\u7269\u8f66\u91cc\u8fd8\u6709"+a+"\u4ef6\u5b9d\u8d1d":F},_parseMsg:function(a){var b=F;return b+='<div class="'+A+'">'+(a&&a!==J?"<p>"+a+"</p>":F)+"<p>"+(a===J?a:F)+'<a target="_top" href="http://ju.atpanel.com/?url='+o+'my_cart.htm?from=mini&ad_id=&am_id=&cm_id=&pm_id=150042785330be233161" class="site-nav-btn">\u67e5\u770b\u6211\u7684\u8d2d\u7269\u8f66</a></p></div>'},_setTimeout:function(b){var c=this;c._timeout||(c._timeout=g.later(function(){b(),c._timeout=a},1e4))},_clearTimeout:function(){var b=this;b._timeout&&b._timeout.cancel(),b._timeout=a},off:function(){this.content.html(this._parseMsg(""))},setData:function(a){var c=this,d=F,e=c.content;if(c._clearTimeout(),a){if(a.status){var f=a.num,h=!1;if(g.isNumber(f)&&-2===f&&(f=c.cartNum-1,h=!0),TB.Global.setCartNum(f),c._data=a,f>0)if(a.item&&a.item.length)d=c._parseItem(a)+c._parseMsg(F);else if(h){var i=e.one(E+A),j=e.one(E+u).all("li").length;j?(i&&i.html(c._parseRest(f-j,f)),d=e.html()):(d=c._parseMsg(i?L:J),c.hide())}else"false"===a.isLogin?(d=c._parseMsg(""),c.hide()):(d=c._parseMsg(L),c.hide());else 0===f&&(d=c._parseMsg(J));c.isExpired=!1,setTimeout(function(){c.isExpired=!0},3e4)}else d=c._parseMsg(a.errMsg);if(-1!==a.num){e.html(d);var k=e.prev("iframe");k&&k.offset(e.offset()).width(e.width()+30).height(e.height()+20),b.use&&b.use("fn-core",function(a,b){b.iframeShim(a.util.$("J_MiniCart"),!0)}),g.each(g.all(E+y),function(a){a=new g.Node(a);var b=280-a.prev(E+w).width()-70,c=a.one("a");c.width(b),H(c)})}}}}}();